---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import { frame, type FrameProps } from './frame';

type Props = FrameProps & {
  image: {
    src: string;
    alt: string;
  };
  caption?: string;
  lazy: boolean;
};

const { caption, image, lazy } = Astro.props;
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/images/content/**/*.{jpeg,jpg,png,gif}',
);
const imageMetaData = images[image.src] && (await images[image.src]()).default;
---

{
  image && imageMetaData && (
    <figure>
      <Picture
        class:list={[frame(Astro.props)]}
        src={import.meta.env.DEV ? image.src : imageMetaData.src}
        alt={image.alt}
        width={imageMetaData.width}
        height={imageMetaData.height}
        formats={['webp']}
        loading={lazy ? 'lazy' : 'eager'}
        fetchpriority={!lazy ? 'high' : undefined}
      />
      {caption && <figcaption class='pt-1 pl-4'>{caption}</figcaption>}
    </figure>
  )
}
